# Архитектура и логика работы приложения Voice Tracker

Этот документ описывает внутреннее устройство проекта, чтобы его можно было понять, воспроизвести и расширить.

## Общая схема работы

Процесс от голосовой команды до обновления ячейки в Excel выглядит так:

`Пользователь (нажимает Enter)` -> `Audio Handler (записывает WAV)` -> `Transcriber (распознает текст)` -> `Command Parser (извлекает категорию)` -> `Spreadsheet Manager (обновляет Excel)`

## Компоненты (модули)

Проект разделен на несколько независимых Python-модулей:

-   **`main.py`**: Главный скрипт. Он инициализирует все объекты, запускает основной цикл прослушивания команд и координирует взаимодействие между другими модулями.
-   **`config.yaml`**: Файл конфигурации в формате YAML. Вынесен отдельно, чтобы не "хардкодить" пути, названия категорий и модели в коде. Скрипт полностью управляется этим файлом.
-   **`audio_handler.py`**: Отвечает исключительно за работу с микрофоном. Его задача — записать звук и сохранить его во временный файл. Он не знает ничего о распознавании или Excel.
-   **`transcriber.py`**: Обертка для библиотеки `whisper`. Его задача — принять путь к аудиофайлу и вернуть распознанный текст. Он не знает, откуда взялся звук и что с текстом будет дальше. Это позволяет в будущем заменить Whisper на другую модель, изменив только этот файл.
-   **`command_parser.py`**: "Мозг" приложения. Принимает сырой текст от транскрибера и конфигурацию с псевдонимами (aliases). Его задача — найти в тексте ключевые слова и вернуть стандартизированное название категории. Логика нечеткого поиска и анализа команд сосредоточена здесь.
-   **`spreadsheet_manager.py`**: Модуль для работы с таблицей. Он принимает название категории и значение для записи. Внутри себя он находит нужную ячейку (по дате и категории) и записывает данные. Важной частью является **система бэкапов**: перед каждой операцией записи создается полная копия файла. Это защищает от потери данных при ошибках.

## Поток данных

1.  `main.py` запускает бесконечный цикл.
2.  `audio_handler.record_audio()` ждет действий пользователя и создает временный `.wav` файл. Путь к файлу возвращается в `main.py`.
3.  `transcriber.transcribe(audio_path)` получает путь, обрабатывает файл и возвращает строку текста в `main.py`.
4.  `command_parser.parse_command(text, aliases)` получает текст и словарь с псевдонимами из конфига. Возвращает название категории (например, `"спорт"`) или `None`, если ничего не найдено.
5.  Если категория найдена, `spreadsheet_manager.update_cell(category, value)` получает имя категории. Внутри он:
    -   Вызывает `_create_backup()` для создания копии.
    -   Открывает `xlsx` файл.
    -   Использует `datetime.now().day` для поиска нужного столбца.
    -   Использует `categories_map` из конфига для поиска нужной строки.
    -   Записывает значение в найденную ячейку.
    -   Сохраняет файл.
6.  `audio_handler.cleanup_audio_file()` удаляет временный `.wav` файл.
7.  Цикл начинается заново.

